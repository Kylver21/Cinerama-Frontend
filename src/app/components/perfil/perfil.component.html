<div class="perfil-container">
  <div class="perfil-header">
    <h1 class="page-title">
      <mat-icon>person</mat-icon>
      Mi Perfil
    </h1>
  </div>

  <div *ngIf="currentUser" class="perfil-content">
    <div class="perfil-info">
      <div class="avatar-section">
        <mat-icon class="avatar-icon">account_circle</mat-icon>
        <h2>{{ currentUser.nombreCompleto || currentUser.username }}</h2>
        <p>{{ currentUser.email }}</p>
        <span class="user-role" *ngFor="let rol of currentUser.roles">{{ rol }}</span>
      </div>
    </div>

    <div class="perfil-tabs">
      <mat-tab-group [selectedIndex]="tabActivo" (selectedIndexChange)="onTabChange($event)">
        <mat-tab label="Informaci√≥n Personal">
          <div class="tab-content info-personal">
            <div class="info-grid">
              <div class="info-item">
                <mat-icon>person</mat-icon>
                <div>
                  <label>Usuario</label>
                  <p>{{ currentUser.username }}</p>
                </div>
              </div>
              <div class="info-item">
                <mat-icon>email</mat-icon>
                <div>
                  <label>Email</label>
                  <p>{{ currentUser.email }}</p>
                </div>
              </div>
              <div class="info-item" *ngIf="currentUser.nombreCompleto">
                <mat-icon>badge</mat-icon>
                <div>
                  <label>Nombre Completo</label>
                  <p>{{ currentUser.nombreCompleto }}</p>
                </div>
              </div>
            </div>
          </div>
        </mat-tab>
        
        <mat-tab label="Mis Compras">
          <div class="tab-content mis-compras">
            <!-- Loading -->
            <div *ngIf="cargandoCompras" class="loading-compras">
              <mat-spinner diameter="40"></mat-spinner>
              <p>Cargando historial de compras...</p>
            </div>

            <!-- Error o mensaje de admin -->
            <div *ngIf="errorCompras && !cargandoCompras" class="error-compras">
              <mat-icon>{{ errorCompras.includes('administrador') ? 'admin_panel_settings' : 'error' }}</mat-icon>
              <p>{{ errorCompras }}</p>
              <button *ngIf="!errorCompras.includes('administrador')" mat-raised-button color="primary" (click)="cargarMisCompras()">
                Reintentar
              </button>
              <a *ngIf="errorCompras.includes('administrador')" mat-raised-button color="primary" (click)="goToAdmin()">
                <mat-icon>dashboard</mat-icon>
                Ir al Panel de Administraci√≥n
              </a>
            </div>

            <!-- Sin compras -->
            <div *ngIf="!cargandoCompras && !errorCompras && misCompras.length === 0" class="sin-compras">
              <mat-icon>local_movies</mat-icon>
              <p>No tienes compras realizadas a√∫n</p>
              <a mat-raised-button color="primary" routerLink="/peliculas">
                <mat-icon>movie</mat-icon>
                Ver Pel√≠culas en Cartelera
              </a>
            </div>

            <!-- Lista de compras -->
            <div *ngIf="!cargandoCompras && !errorCompras && misCompras.length > 0" class="compras-list">
              <h3>üéüÔ∏è Mis Boletos ({{ misCompras.length }})</h3>
              
              <div class="boleto-card" *ngFor="let boleto of misCompras">
                <div class="boleto-header">
                  <div class="pelicula-info">
                    <img *ngIf="boleto.funcion?.pelicula?.posterUrl" 
                         [src]="boleto.funcion?.pelicula?.posterUrl" 
                         [alt]="boleto.funcion?.pelicula?.titulo || 'Poster'"
                         class="poster-mini">
                    <div class="pelicula-detalles">
                      <h4>{{ boleto.funcion?.pelicula?.titulo || 'Pel√≠cula' }}</h4>
                      <p class="sala-info">
                        <mat-icon>meeting_room</mat-icon>
                        {{ boleto.funcion?.sala?.nombre || 'Sala' }}
                      </p>
                    </div>
                  </div>
                  <span class="estado-badge" [ngClass]="getEstadoClass(boleto.estado)">
                    {{ boleto.estado }}
                  </span>
                </div>
                
                <div class="boleto-body">
                  <div class="boleto-detalle">
                    <mat-icon>event_seat</mat-icon>
                    <span>Asiento: <strong>{{ getCodigoAsiento(boleto.asiento) }}</strong></span>
                  </div>
                  <div class="boleto-detalle">
                    <mat-icon>schedule</mat-icon>
                    <span>{{ formatFecha(boleto.funcion?.fechaHora) }}</span>
                  </div>
                  <div class="boleto-detalle">
                    <mat-icon>calendar_today</mat-icon>
                    <span>Comprado: {{ formatFecha(boleto.fechaCompra) }}</span>
                  </div>
                  <div class="boleto-detalle precio">
                    <mat-icon>payments</mat-icon>
                    <span>S/. {{ boleto.precio | number:'1.2-2' }}</span>
                  </div>
                </div>

                <div class="boleto-qr" *ngIf="boleto.codigoQR">
                  <mat-icon>qr_code_2</mat-icon>
                  <span>{{ boleto.codigoQR }}</span>
                </div>
              </div>
            </div>
          </div>
        </mat-tab>
        
        <mat-tab label="Configuraci√≥n">
          <div class="tab-content">
            <div class="config-section">
              <h3>Configuraci√≥n de Cuenta</h3>
              <p class="coming-soon">
                <mat-icon>build</mat-icon>
                Pr√≥ximamente: Cambiar contrase√±a, notificaciones y m√°s.
              </p>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>
  </div>
</div>




