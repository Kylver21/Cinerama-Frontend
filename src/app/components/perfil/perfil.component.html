<div class="perfil-container">
  <div class="perfil-header">
    <h1 class="page-title">
      <mat-icon>person</mat-icon>
      Mi Perfil
    </h1>
  </div>

  <div *ngIf="currentUser" class="perfil-content">
    <div class="perfil-info">
      <div class="avatar-section">
        <mat-icon class="avatar-icon">account_circle</mat-icon>
        <h2>{{ currentUser.nombreCompleto || currentUser.username }}</h2>
        <p>{{ currentUser.email }}</p>
        <span class="user-role" *ngFor="let rol of currentUser.roles">{{ rol }}</span>
      </div>
    </div>

    <div class="perfil-tabs">
      <mat-tab-group [selectedIndex]="tabActivo" (selectedIndexChange)="onTabChange($event)">
        <mat-tab label="Informaci칩n Personal">
          <div class="tab-content info-personal">
            <div class="info-grid">
              <div class="info-item">
                <mat-icon>person</mat-icon>
                <div>
                  <label>Usuario</label>
                  <p>{{ currentUser.username }}</p>
                </div>
              </div>
              <div class="info-item">
                <mat-icon>email</mat-icon>
                <div>
                  <label>Email</label>
                  <p>{{ currentUser.email }}</p>
                </div>
              </div>
              <div class="info-item" *ngIf="currentUser.nombreCompleto">
                <mat-icon>badge</mat-icon>
                <div>
                  <label>Nombre Completo</label>
                  <p>{{ currentUser.nombreCompleto }}</p>
                </div>
              </div>
            </div>
          </div>
        </mat-tab>
        
        <mat-tab label="Mis Compras">
          <div class="tab-content mis-compras">
            <!-- Loading -->
            <div *ngIf="cargandoCompras" class="loading-compras">
              <mat-spinner diameter="40"></mat-spinner>
              <p>Cargando historial de compras...</p>
            </div>

            <!-- Error o mensaje de admin -->
            <div *ngIf="errorCompras && !cargandoCompras" class="error-compras">
              <mat-icon>{{ errorCompras.includes('administrador') ? 'admin_panel_settings' : 'error' }}</mat-icon>
              <p>{{ errorCompras }}</p>
              <button *ngIf="!errorCompras.includes('administrador')" mat-raised-button color="primary" (click)="cargarMisCompras()">
                Reintentar
              </button>
              <a *ngIf="errorCompras.includes('administrador')" mat-raised-button color="primary" (click)="goToAdmin()">
                <mat-icon>dashboard</mat-icon>
                Ir al Panel de Administraci칩n
              </a>
            </div>

            <!-- Sin compras -->
            <div *ngIf="!cargandoCompras && !errorCompras && historialCompras.length === 0" class="sin-compras">
              <mat-icon>local_movies</mat-icon>
              <p>No tienes compras realizadas a칰n</p>
              <a mat-raised-button color="primary" routerLink="/peliculas">
                <mat-icon>movie</mat-icon>
                Ver Pel칤culas en Cartelera
              </a>
            </div>

            <!-- Lista de compras -->
            <div *ngIf="!cargandoCompras && !errorCompras && historialCompras.length > 0" class="compras-list">
              <h3>游 Historial de Compras ({{ historialCompras.length }})</h3>

              <div class="boleto-card" *ngFor="let compra of historialCompras">
                <div class="boleto-header">
                  <div class="pelicula-info">
                    <img *ngIf="compra.posterUrl" 
                         [src]="compra.posterUrl" 
                         [alt]="compra.peliculaTitulo || 'Poster'"
                         class="poster-mini">
                    <div class="pelicula-detalles">
                      <h4>{{ compra.peliculaTitulo || 'Compra' }}</h4>
                      <p class="sala-info" *ngIf="compra.salaNombre">
                        <mat-icon>meeting_room</mat-icon>
                        {{ compra.salaNombre }}
                      </p>
                    </div>
                  </div>
                  <span class="estado-badge" [ngClass]="getEstadoClass(compra.estado || 'PAGADO')">
                    {{ compra.estado || 'PAGADO' }}
                  </span>
                </div>

                <div class="boleto-body">
                  <div class="boleto-detalle" *ngIf="compra.asientos.length > 0">
                    <mat-icon>event_seat</mat-icon>
                    <span>Asientos: <strong>{{ getAsientosLabel(compra) }}</strong></span>
                  </div>

                  <div class="boleto-detalle" *ngIf="compra.fechaFuncion">
                    <mat-icon>schedule</mat-icon>
                    <span>{{ formatFecha(compra.fechaFuncion) }}</span>
                  </div>

                  <div class="boleto-detalle" *ngIf="compra.fechaCompra">
                    <mat-icon>calendar_today</mat-icon>
                    <span>Comprado: {{ formatFecha(compra.fechaCompra) }}</span>
                  </div>

                  <div class="boleto-detalle" *ngIf="compra.metodoPago">
                    <mat-icon>credit_card</mat-icon>
                    <span>M칠todo: {{ compra.metodoPago }}</span>
                  </div>

                  <div class="boleto-detalle precio">
                    <mat-icon>payments</mat-icon>
                    <span>S/. {{ getTotal(compra) | number:'1.2-2' }}</span>
                  </div>
                </div>

                <div class="productos-resumen" *ngIf="getTieneProductos(compra)">
                  <div class="productos-title">
                    <mat-icon>local_cafe</mat-icon>
                    <span>Chocolater칤a</span>
                  </div>
                  <div class="productos-grid">
                    <div class="producto-item" *ngFor="let p of compra.productos">
                      <span class="producto-nombre">{{ p.nombre }}</span>
                      <span class="producto-cantidad">x{{ p.cantidad }}</span>
                      <span class="producto-subtotal">S/. {{ p.subtotal | number:'1.2-2' }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </mat-tab>
        
        <mat-tab label="Configuraci칩n">
          <div class="tab-content">
            <div class="config-section">
              <h3>Configuraci칩n de Cuenta</h3>
              <p class="coming-soon">
                <mat-icon>build</mat-icon>
                Pr칩ximamente: Cambiar contrase침a, notificaciones y m치s.
              </p>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>
  </div>
</div>




